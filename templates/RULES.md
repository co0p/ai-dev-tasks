# Shared Prompt Rules for 4dc Templates

These rules apply to **all** 4dc templates (constitution, increment, design, implement, improve, etc.).  
They describe how the executing LLM must use context, follow the defined flow, and shape its outputs.

You can treat this file as a **checklist** when editing templates.

---

## 1. Scope & Target Context

### R1. Clearly define the target scope

- The template MUST define a **target scope argument** (for example: project root path, service name, file path, or similar).
- The executing LLM MUST:
  - Treat this target scope as the **only subject** of the prompt.
  - Use content **inside that scope** for:
    - Problem or product description.
    - Code / architecture understanding.
    - Constraints and non‑negotiables.
  - Treat content **outside that scope** as:
    - Tooling, frameworks, or background material.
    - NEVER as the primary subject of the prompt.

### R2. Separate subject from host/framework

- When the subject project/code lives **inside** a larger framework or mono‑repo, the LLM MUST:
  - Treat the inner project as the **subject**.
  - Treat the surrounding repo (framework, prompts, examples) as **tooling/background only**.
- The final outputs MUST NOT:
  - Describe or name the host/framework repo (e.g., “4dc”, prompt infrastructure) **unless**:
    - It is an explicit runtime dependency of the subject, or
    - It is a deliberate and relevant part of the subject’s architecture or domain.

---

## 2. Context Inference

### R3. Primary description source

- The template MUST identify a **primary description artifact** (for example, a root `README.md`, main spec file, or top‑level doc for the scope).
- The LLM MUST:
  - Use this artifact as the **authoritative source** of:
    - What the subject is.
    - Who it serves.
    - High‑level goals.
  - NOT merge multiple unrelated descriptions (e.g., test/example READMEs) into a single product/system description.

### R4. Supporting artifacts

- Supporting artifacts (architecture docs, ADRs, workflows, tests, code) MAY be used to infer:
  - Architecture and design intent.
  - Engineering practices and conventions.
  - Non‑functional constraints (performance, reliability, security, etc.).
- They MUST be treated as **refinements** of the primary description, not as separate, competing products.

---

## 3. Internal Notes & Reasoning

### R5. Maintain internal working notes

- The LLM SHOULD maintain internal notes such as:
  - Subject context (domain, users, goals).
  - Values/priorities and constraints.
  - Existing practices & examples.
  - Known non‑negotiables.
- These notes MUST be used to:
  - Drive clarifying questions.
  - Shape the plan or outline.
  - Inform the final output.
- Unless a template explicitly asks to expose them, these notes MUST NOT be shown as raw placeholders or “internal note” sections in the final output.

---

## 4. Mandatory Execution Cycle

### R6. Follow the defined cycle exactly

Each template defines a specific cycle (for example, for constitution:  
**infer → clarify → plan → confirm → write**).

- The LLM MUST:
  - Identify the cycle steps defined in that template.
  - Follow them **in the given order**.
  - NOT reorder, fuse, or omit steps, **unless** the template explicitly allows it.

A typical pattern (to be adapted per template):

1. **Infer** – scan the allowed context and build internal understanding.
2. **Clarify** – present a short summary; ask targeted questions if needed.
3. **Plan** – propose a brief, human‑readable plan or outline.
4. **Confirm (STOP)** – ask for explicit confirmation (`yes`/`no` or equivalent).
5. **Execute** – after confirmation, perform the requested generation/change exactly as planned (accounting for any agreed adjustments).
6. **Report** – confirm what was done (files written/updated, key decisions).

### R7. Respect STOP gates and confirmations

- Templates MAY define explicit **STOP** points.
- At each STOP point, the LLM MUST:
  - Present the requested summary/plan/outline.
  - Ask the user for an explicit **yes/no** (or equivalent) confirmation.
- If the user answers **no**:
  - The LLM MUST ask what should be changed.
  - Update the plan accordingly and re‑present it.
- If the user answers **yes**:
  - The LLM MUST proceed to the execution phase.
- The LLM MUST NOT:
  - Silently advance past a STOP gate without explicit confirmation.
  - Perform file‑writing or irreversible changes before receiving a clear **yes**.

---

## 5. Output Content Constraints

### R8. No meta‑assistant chatter in final artifacts

- Final artifacts (e.g., `CONSTITUTION.md`, increment definitions, design docs, ADRs) MUST:
  - Read as standalone documents for humans.
  - NOT refer to themselves as “generated by an assistant” or “this prompt”.
- They MUST NOT contain:
  - “If you’d like, I can also…”
  - “Next, I can create…”
  - “I can generate a workflow / ADR for you…”
  - Any discussion of what the assistant *could* do next.

### R9. No additional suggestions or tasks inside artifacts

- The body of the artifact MUST NOT include:
  - Assistant‑offered actions (e.g., “I can create CI for you now”).
  - Proposals to create other files, workflows, or tickets.
  - Checklists of tasks for the assistant itself.
- It IS acceptable to describe **project responsibilities and processes** (e.g., “We record ADRs when…”), as long as they are framed as team/project behavior, not assistant behavior.

### R10. Keep outputs within the defined structure

- Each template defines an expected output structure (headings, sections, or JSON shape).
- The final output MUST:
  - Match this structure.
  - Include all required sections/fields.
- The LLM MUST NOT:
  - Add new top‑level sections that the template did not ask for.
  - Omit required sections.
- If the template explicitly allows extensions, the LLM MAY extend only in those allowed places.

---

## 6. Clarifying Questions

### R11. Ask clarifying questions when needed

- If critical information is missing, ambiguous, or conflicting, the LLM MUST:
  - Ask **specific, targeted** clarifying questions.
  - Use questions primarily for:
    - Non‑negotiables and constraints.
    - Priorities when trade‑offs conflict.
    - Ambiguities in the subject description or goals.

### R12. Don’t over‑ask

- The LLM MUST NOT:
  - Ask long, unfocused questionnaires.
  - Block progress waiting on answers to trivial or non‑critical questions.
- Prefer:
  - “I’m unsure about X vs Y; which is closer to your intent?”  
    over  
  - “Answer these 20 generic questions about your project.”

---

## 7. Style & Focus

### R13. Subject‑focused, not tool‑focused

- The LLM MUST keep the focus on **the project/problem/domain**, not on:
  - The prompt system.
  - The hosting framework repo.
  - The assistant itself.
- Tools/frameworks MAY be mentioned only when:
  - They are important to the architecture or workflow, or
  - The template explicitly requests such details.

### R14. Opinionated but clear

- Outputs SHOULD be:
  - Clear and succinct.
  - Explicit about trade‑offs and default choices (e.g., speed vs safety).
- The LLM SHOULD avoid:
  - Purely hedged answers like “it depends” without guidance.
- Where appropriate, the LLM SHOULD provide:
  - Concrete decision rules.
  - Clear defaults and when to override them.

---

## 8. Optimize for DORA & Modern Software Engineering

### R15. DORA‑aligned practices

- Templates SHOULD encourage:
  - Small, frequent, and reversible changes.
  - Strong automated feedback loops (tests, CI, linting, type checks).
  - Clear deployment and rollback paths.
  - Good observability (logging, metrics, traces where appropriate).
  - Continuous learning through structured improvement and ADRs.
- Where there are trade‑offs, prefer approaches that:
  - Reduce **lead time for changes**.
  - Lower **change failure rate**.
  - Improve **mean time to restore (MTTR)**.
  - Enable **higher deployment frequency** with confidence.

---

## 9. File Operations (when applicable)

### R16. Write/update files only after confirmation

- When a template includes file operations (e.g., writing `CONSTITUTION.md`, ADRs, design docs), the LLM MUST:
  - Only create or update files **after**:
    - Presenting a plan/summary of what will be written.
    - Receiving explicit user confirmation (e.g. “yes”).
- Once confirmed, the LLM MUST:
  - Use the exact target path defined by the template (such as project root or ADR directory).
  - Create or overwrite files as specified.
- After writing, the LLM MUST:
  - Inform the user which files were written/updated.
  - Include the exact paths.

---

## How to Use These Rules

- When editing or adding a template under `templates/`:
  - Ensure the template enforces or aligns with rules **R1–R16**.
  - Use this file as a checklist during reviews.

- When validating a template:
  - You can ask:  
    > “Run the shared RULES checklist (R1–R16) against `templates/<name>/*.md` and tell me where it violates or omits any rules.”

This keeps all prompts in the 4dc repo consistent in how they handle scope, flow, clarifications, file changes, DORA alignment, and final outputs.